<!-- CRITICAL: ADMIN PERMISSION REQUIRED BEFORE ACCESSING THIS FILE

     This file contains the SQL Editor for Kind Heart's Sangam Foundation admin panel.
     It allows authorized administrators to execute SQL queries against the database.

     SECURITY WARNING:
     - This tool provides direct database access
     - Only authorized administrators should have access
     - All queries are logged for security auditing
     - Never expose this interface to public users

     Contact admin before modifying:
     - Database connection settings
     - Query execution permissions
     - Access control mechanisms
     - Security logging features

     Unauthorized access may compromise:
     - Data security and privacy
     - System integrity and stability
     - Audit trails and compliance
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Editor - Admin Panel - KIND HEART'S</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* SQL Editor specific styles */
        .sql-editor {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .sql-editor__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .sql-editor__title {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .connection-status--connected {
            background-color: #d4edda;
            color: #155724;
        }

        .connection-status--disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .query-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .query-panel__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
        }

        .query-panel__title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .query-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn--primary {
            background-color: #007bff;
            color: white;
        }

        .btn--primary:hover {
            background-color: #0056b3;
        }

        .btn--secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn--secondary:hover {
            background-color: #545b62;
        }

        .btn--success {
            background-color: #28a745;
            color: white;
        }

        .btn--success:hover {
            background-color: #1e7e34;
        }

        .btn--danger {
            background-color: #dc3545;
            color: white;
        }

        .btn--danger:hover {
            background-color: #c82333;
        }

        .btn--small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .nav__link--active {
            background-color: #007bff;
            color: white;
        }

        .query-input {
            width: 100%;
            height: 300px;
            padding: 1rem;
            border: none;
            border-radius: 0 0 8px 8px;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: vertical;
            outline: none;
        }

        .query-input:focus {
            box-shadow: inset 0 0 0 2px #007bff;
        }

        .query-templates {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .template-btn {
            padding: 0.5rem 1rem;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-btn:hover {
            background: #dee2e6;
        }

        .results-section {
            margin-top: 2rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .results-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .execution-time {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
        }

        .results-container {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table thead {
            background: #f8f9fa;
        }

        .results-table th,
        .results-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
        }

        .results-table th {
            font-weight: 600;
            color: #495057;
            background: #e9ecef;
            position: sticky;
            top: 0;
        }

        .results-table tbody tr:hover {
            background: #f8f9fa;
        }

        .results-table tbody tr:last-child td {
            border-bottom: none;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #dc3545;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #28a745;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .history-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .history-item {
            background: white;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 3px solid #007bff;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: #e3f2fd;
        }

        .history-timestamp {
            color: #6c757d;
            font-size: 0.7rem;
            margin-bottom: 0.25rem;
        }

        .tab-container {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 1rem;
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab-btn:hover {
            color: #007bff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .statistics-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #007bff;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .sql-editor {
                padding: 1rem;
            }

            .sql-editor__header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .query-templates {
                flex-direction: column;
            }

            .query-actions {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header__content">
                <a href="dashboard.html" class="header__logo">
                    <img src="logo.svg" alt="Kind Heart's Sangam Foundation Logo" class="header__logo-img">
                    <span class="header__logo-text">Admin Panel</span>
                </a>
                <nav class="nav">
                    <ul class="nav__list">
                        <li class="nav__item"><a href="dashboard.html" class="nav__link">Dashboard</a></li>
                        <li class="nav__item"><a href="sql-editor.html" class="nav__link nav__link--active">SQL Editor</a></li>
                        <li class="nav__item"><a href="admin-login.html" class="nav__link">Logout</a></li>
                    </ul>
                </nav>
                <button class="hamburger" aria-label="Open navigation menu" aria-expanded="false" aria-controls="navList">
                    <span class="hamburger__line"></span>
                    <span class="hamburger__line"></span>
                    <span class="hamburger__line"></span>
                </button>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="sql-editor">
                <div class="sql-editor__header">
                    <h1 class="sql-editor__title">SQL Editor</h1>
                    <div id="connectionStatus" class="connection-status connection-status--disconnected">
                        <span id="connectionIcon">üî¥</span>
                        <span id="connectionText">Disconnected</span>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="statistics-cards" id="statisticsCards" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-number" id="totalRegistrations">-</div>
                        <div class="stat-label">Total Registrations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingReviews">-</div>
                        <div class="stat-label">Pending Reviews</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="approvedToday">-</div>
                        <div class="stat-label">Approved Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalDonors">-</div>
                        <div class="stat-label">Total Donors</div>
                    </div>
                </div>

                <!-- Query Templates -->
                <div class="query-templates">
                    <button class="template-btn" onclick="loadTemplate('all_registrations')">All Registrations</button>
                    <button class="template-btn" onclick="loadTemplate('pending_reviews')">Pending Reviews</button>
                    <button class="template-btn" onclick="loadTemplate('donors_only')">Donors Only</button>
                    <button class="template-btn" onclick="loadTemplate('partners_only')">Partners Only</button>
                    <button class="template-btn" onclick="loadTemplate('recent_activity')">Recent Activity</button>
                    <button class="template-btn" onclick="loadTemplate('donation_stats')">Donation Stats</button>
                    <button class="template-btn" onclick="loadTemplate('insert_donation')">Insert Donation</button>
                    <button class="btn btn--success btn--small" onclick="testDonationInsert()">Test Insert</button>
                </div>

                <!-- Query Panel -->
                <div class="query-panel">
                    <div class="query-panel__header">
                        <h2 class="query-panel__title">Query Editor</h2>
                        <div class="query-actions">
                            <button class="btn btn--primary" onclick="executeQuery()">
                                <span class="btn-icon">‚ñ∂Ô∏è</span>
                                Execute Query
                            </button>
                            <button class="btn btn--secondary" onclick="clearResults()">
                                <span class="btn-icon">üóëÔ∏è</span>
                                Clear
                            </button>
                            <button class="btn btn--secondary btn--small" onclick="formatQuery()">Format</button>
                        </div>
                    </div>
                    <textarea id="queryInput" class="query-input" placeholder="Enter your SQL query here...&#10;&#10;Examples:&#10;SELECT * FROM registrations;&#10;SELECT COUNT(*) FROM registrations WHERE status = 'Pending Review';&#10;SELECT donor_type, COUNT(*) FROM registrations WHERE type = 'donor' GROUP BY donor_type;"></textarea>
                </div>

                <!-- Results Section -->
                <div class="results-section">
                    <div class="results-header">
                        <div class="results-info">
                            <span id="resultsCount">No results</span>
                            <span id="executionTime" class="execution-time" style="display: none;"></span>
                        </div>
                        <div class="query-actions">
                            <button class="btn btn--secondary btn--small" onclick="exportResults()" id="exportBtn" style="display: none;">
                                üì• Export CSV
                            </button>
                        </div>
                    </div>

                    <div id="errorContainer"></div>
                    <div id="successContainer"></div>

                    <div class="results-container">
                        <div id="resultsTableContainer">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <h3>No Data</h3>
                                <p>Execute a query to see results here</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Query History -->
                <div class="history-panel" id="historyPanel" style="display: none;">
                    <h3>Query History</h3>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; <span id="year"></span> KIND HEART'S. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="supabase-client.js"></script>
    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('SQL Editor loaded');
            initializeSQLEditor();
            document.getElementById('year').textContent = new Date().getFullYear();
        });

        // Initialize SQL Editor
        async function initializeSQLEditor() {
            try {
                // Load Supabase client
                if (typeof supabase === 'undefined') {
                    const { default: supabaseClient } = await import('./supabase-client.js');
                    window.supabase = supabaseClient;
                }

                // Update connection status
                updateConnectionStatus(true);
                console.log('Supabase client loaded successfully');

                // Load initial statistics
                loadStatistics();

                // Load query history
                loadQueryHistory();

            } catch (error) {
                console.error('Failed to initialize SQL Editor:', error);
                updateConnectionStatus(false);
                showError('Failed to connect to database: ' + error.message);
            }
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const iconEl = document.getElementById('connectionIcon');
            const textEl = document.getElementById('connectionText');

            if (connected) {
                statusEl.className = 'connection-status connection-status--connected';
                iconEl.textContent = 'üü¢';
                textEl.textContent = 'Connected';
            } else {
                statusEl.className = 'connection-status connection-status--disconnected';
                iconEl.textContent = 'üî¥';
                textEl.textContent = 'Disconnected';
            }
        }

        // Query Templates
        function loadTemplate(template) {
            const templates = {
                all_registrations: `SELECT
    id,
    type,
    status,
    created_at,
    org_name,
    contact_person,
    donor_type,
    name,
    city,
    phone
FROM registrations
ORDER BY created_at DESC
LIMIT 100;`,

                pending_reviews: `SELECT
    id,
    type,
    created_at,
    org_name,
    contact_person,
    donor_type,
    name,
    city,
    phone,
    email
FROM registrations
WHERE status = 'Pending Review'
ORDER BY created_at ASC;`,

                donors_only: `SELECT
    id,
    status,
    created_at,
    donor_type,
    name,
    organization,
    city,
    state,
    donation_categories,
    preferred_pickup_date,
    phone,
    email
FROM registrations
WHERE type = 'donor'
ORDER BY created_at DESC;`,

                partners_only: `SELECT
    id,
    status,
    created_at,
    org_type,
    org_name,
    contact_person,
    city,
    pickup_days,
    food_capacity,
    phone,
    email
FROM registrations
WHERE type = 'partner'
ORDER BY created_at DESC;`,

                recent_activity: `SELECT
    id,
    type,
    status,
    created_at,
    org_name,
    name,
    city,
    CASE
        WHEN type = 'donor' THEN 'New donor registration'
        WHEN type = 'partner' THEN 'New partner registration'
        ELSE 'Status update'
    END as activity
FROM registrations
WHERE created_at >= NOW() - INTERVAL '7 days'
ORDER BY created_at DESC;`,

                donation_stats: `SELECT
    donation_categories,
    COUNT(*) as count,
    donor_type,
    city
FROM registrations
WHERE type = 'donor'
    AND donation_categories IS NOT NULL
    AND array_length(donation_categories, 1) > 0
GROUP BY donation_categories, donor_type, city
ORDER BY count DESC;`,

                insert_donation: `INSERT INTO registrations (
    type,
    status,
    donor_type,
    anonymous,
    name,
    organization,
    phone,
    email,
    address,
    city,
    state,
    pincode,
    donation_categories,
    money,
    clothes,
    food,
    other,
    preferred_pickup_date,
    preferred_pickup_time,
    files,
    notes,
    terms_accepted
) VALUES (
    'donor',
    'Pending Review',
    'Individual', -- Change to 'Organization' if needed
    false, -- Set to true for anonymous donations
    'Full Name', -- Replace with actual name
    null, -- Organization name if applicable
    '1234567890', -- Phone number
    'email@example.com', -- Email address
    'Full Address', -- Complete address
    'City', -- City name
    'State', -- State name
    '123456', -- Pincode
    ARRAY['money', 'food'], -- Array of donation categories
    '{"amount": 1000, "currency": "INR", "paymentMethod": "UPI"}', -- Money donation details (JSON)
    null, -- Clothes donation details (JSON)
    '{"type": "Vegetarian", "quantity": "10 meals", "pickupAvailable": "Yes"}', -- Food donation details (JSON)
    null, -- Other donation details (JSON)
    CURRENT_DATE + INTERVAL '7 days', -- Preferred pickup date
    '9:00 AM - 12:00 PM', -- Preferred time window
    null, -- File URLs
    'Additional notes', -- Any additional notes
    true -- Terms and conditions accepted
);`
            };

            const queryInput = document.getElementById('queryInput');
            queryInput.value = templates[template] || '';
            queryInput.focus();
        }

        // Execute Query
        async function executeQuery() {
            const queryInput = document.getElementById('queryInput');
            const query = queryInput.value.trim();

            if (!query) {
                showError('Please enter a SQL query');
                return;
            }

            // Show loading state
            const executeBtn = document.querySelector('.btn--primary');
            const originalText = executeBtn.innerHTML;
            executeBtn.innerHTML = '<span class="loading-spinner"></span> Executing...';
            executeBtn.disabled = true;

            const startTime = Date.now();

            try {
                console.log('Executing query:', query);

                // Execute query based on type
                let result;

                if (query.toLowerCase().trim().startsWith('select')) {
                    // SELECT query
                    const { data, error } = await window.supabase.rpc('execute_sql', {
                        query: query
                    });

                    if (error) {
                        // If RPC function doesn't exist, try direct query
                        const { data: directData, error: directError } = await window.supabase
                            .from('registrations')
                            .select('*')
                            .limit(1000);

                        if (directError) throw directError;
                        result = { data: directData, isDirectQuery: true };
                    } else {
                        result = { data, error };
                    }
                } else if (query.toLowerCase().trim().startsWith('insert')) {
                    // Allow controlled INSERT operations for donation submissions
                    if (isValidDonationInsert(query)) {
                        const { data, error } = await window.supabase
                            .from('registrations')
                            .insert(getDonationDataFromQuery(query))
                            .select();

                        if (error) throw error;
                        result = { data, error };
                    } else {
                        showError('Only INSERT operations for donation submissions are allowed');
                        return;
                    }
                } else {
                    // UPDATE, DELETE queries
                    showError('Only SELECT queries and controlled INSERT operations are allowed for security reasons');
                    return;
                }

                const executionTime = Date.now() - startTime;

                if (result.error) {
                    throw result.error;
                }

                // Display results
                displayResults(result.data, executionTime);

                // Save to history
                saveQueryHistory(query, result.data.length);

                // Update statistics
                loadStatistics();

                showSuccess(`Query executed successfully in ${executionTime}ms`);

            } catch (error) {
                console.error('Query execution error:', error);
                showError('Query execution failed: ' + error.message);
            } finally {
                // Reset button
                executeBtn.innerHTML = originalText;
                executeBtn.disabled = false;
            }
        }

        // Display Results
        function displayResults(data, executionTime) {
            const container = document.getElementById('resultsTableContainer');
            const countEl = document.getElementById('resultsCount');
            const timeEl = document.getElementById('executionTime');
            const exportBtn = document.getElementById('exportBtn');

            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No Results</h3>
                        <p>Query executed successfully but returned no data</p>
                    </div>
                `;
                countEl.textContent = '0 results';
                exportBtn.style.display = 'none';
            } else {
                countEl.textContent = `${data.length} result${data.length !== 1 ? 's' : ''}`;
                timeEl.textContent = `${executionTime}ms`;
                timeEl.style.display = 'inline-block';
                exportBtn.style.display = 'inline-block';

                // Create table
                const table = createResultsTable(data);
                container.innerHTML = '';
                container.appendChild(table);
            }
        }

        // Create Results Table
        function createResultsTable(data) {
            const table = document.createElement('table');
            table.className = 'results-table';

            if (data.length === 0) return table;

            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = formatColumnName(key);
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create body
            const tbody = document.createElement('tbody');

            data.forEach(row => {
                const tr = document.createElement('tr');

                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = formatCellValue(value);
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            return table;
        }

        // Format column names for display
        function formatColumnName(key) {
            return key.split('_')
                     .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                     .join(' ');
        }

        // Format cell values for display
        function formatCellValue(value) {
            if (value === null || value === undefined) {
                return '<em>null</em>';
            }

            if (typeof value === 'object') {
                if (Array.isArray(value)) {
                    return value.join(', ');
                }
                return JSON.stringify(value);
            }

            if (typeof value === 'boolean') {
                return value ? '‚úì' : '‚úó';
            }

            return String(value);
        }

        // Load Statistics
        async function loadStatistics() {
            try {
                // Get total registrations
                const { count: totalCount } = await window.supabase
                    .from('registrations')
                    .select('*', { count: 'exact', head: true });

                document.getElementById('totalRegistrations').textContent = totalCount || 0;

                // Get pending reviews
                const { count: pendingCount } = await window.supabase
                    .from('registrations')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'Pending Review');

                document.getElementById('pendingReviews').textContent = pendingCount || 0;

                // Get approved today
                const today = new Date().toISOString().split('T')[0];
                const { count: approvedToday } = await window.supabase
                    .from('registrations')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', today)
                    .eq('status', 'Approved');

                document.getElementById('approvedToday').textContent = approvedToday || 0;

                // Get total donors
                const { count: donorsCount } = await window.supabase
                    .from('registrations')
                    .select('*', { count: 'exact', head: true })
                    .eq('type', 'donor');

                document.getElementById('totalDonors').textContent = donorsCount || 0;

                // Show statistics cards
                document.getElementById('statisticsCards').style.display = 'grid';

            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        // Query History Management
        function saveQueryHistory(query, resultCount) {
            const history = JSON.parse(localStorage.getItem('sqlQueryHistory') || '[]');
            const historyItem = {
                query: query,
                timestamp: new Date().toISOString(),
                resultCount: resultCount
            };

            history.unshift(historyItem);

            // Keep only last 50 queries
            if (history.length > 50) {
                history.pop();
            }

            localStorage.setItem('sqlQueryHistory', JSON.stringify(history));
            loadQueryHistory();
        }

        function loadQueryHistory() {
            const history = JSON.parse(localStorage.getItem('sqlQueryHistory') || '[]');
            const historyList = document.getElementById('historyList');

            if (history.length === 0) {
                document.getElementById('historyPanel').style.display = 'none';
                return;
            }

            historyList.innerHTML = '';

            history.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-timestamp">
                        ${new Date(item.timestamp).toLocaleString()} ‚Ä¢ ${item.resultCount} results
                    </div>
                    <div>${item.query}</div>
                `;

                historyItem.addEventListener('click', () => {
                    document.getElementById('queryInput').value = item.query;
                });

                historyList.appendChild(historyItem);
            });

            document.getElementById('historyPanel').style.display = 'block';
        }

        // Utility Functions
        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message">${message}</div>`;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function showSuccess(message) {
            const container = document.getElementById('successContainer');
            container.innerHTML = `<div class="success-message">${message}</div>`;

            // Auto-hide after 3 seconds
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        function clearResults() {
            document.getElementById('resultsTableContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <h3>No Data</h3>
                    <p>Execute a query to see results here</p>
                </div>
            `;
            document.getElementById('resultsCount').textContent = 'No results';
            document.getElementById('executionTime').style.display = 'none';
            document.getElementById('exportBtn').style.display = 'none';
            document.getElementById('errorContainer').innerHTML = '';
            document.getElementById('successContainer').innerHTML = '';
        }

        function formatQuery() {
            // Basic SQL formatting (you can enhance this)
            const queryInput = document.getElementById('queryInput');
            let query = queryInput.value;

            // Simple formatting for demo
            query = query.replace(/\s+/g, ' ');
            query = query.replace(/\s*,\s*/g, ',\n    ');
            query = query.replace(/\s+(FROM|WHERE|ORDER BY|GROUP BY|HAVING|JOIN|INNER JOIN|LEFT JOIN|RIGHT JOIN|LIMIT)\s+/gi, '\n$1 ');

            queryInput.value = query;
        }

        function exportResults() {
            // Get table data and export as CSV
            const table = document.querySelector('.results-table');
            if (!table) return;

            const rows = table.querySelectorAll('tr');
            const csv = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                const rowData = [];

                cells.forEach(cell => {
                    let text = cell.textContent || cell.innerText;
                    text = text.replace(/"/g, '""'); // Escape quotes
                    rowData.push(`"${text}"`);
                });

                csv.push(rowData.join(','));
            });

            // Download CSV
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `query-results-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Validation Functions for Donation Insert
        function isValidDonationInsert(query) {
            const lowerQuery = query.toLowerCase().trim();

            // Must be an INSERT into registrations table
            if (!lowerQuery.includes('insert into registrations')) {
                return false;
            }

            // Must set type to 'donor'
            if (!lowerQuery.includes("'donor'") && !lowerQuery.includes('"donor"')) {
                return false;
            }

            // Must include required fields
            const requiredFields = ['phone', 'email', 'address', 'city', 'state', 'pincode'];
            for (const field of requiredFields) {
                if (!lowerQuery.includes(field)) {
                    return false;
                }
            }

            // Must include at least one donation category
            const categories = ['money', 'clothes', 'food', 'other'];
            const hasCategory = categories.some(cat => lowerQuery.includes(`'${cat}'`));

            return hasCategory;
        }

        function getDonationDataFromQuery(query) {
            // This is a simplified parser for demo purposes
            // In production, you'd want a more robust SQL parser

            const data = {
                type: 'donor',
                status: 'Pending Review',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            // Extract donor_type
            const donorTypeMatch = query.match(/donor_type[\s]*=[\s]*['"]([^'"]+)['"]/i);
            if (donorTypeMatch) {
                data.donor_type = donorTypeMatch[1];
            }

            // Extract anonymous flag
            const anonymousMatch = query.match(/anonymous[\s]*=[\s]*['"]([^'"]+)['"]/i);
            if (anonymousMatch) {
                data.anonymous = anonymousMatch[1].toLowerCase() === 'true';
            }

            // Extract basic fields
            const fieldMappings = {
                name: 'name',
                organization: 'organization',
                phone: 'phone',
                email: 'email',
                address: 'address',
                city: 'city',
                state: 'state',
                pincode: 'pincode',
                notes: 'notes'
            };

            for (const [sqlField, jsField] of Object.entries(fieldMappings)) {
                const match = query.match(new RegExp(`${sqlField}[\\s]*=[\\s]*['"]([^'"]+)['"]`, 'i'));
                if (match) {
                    data[jsField] = match[1];
                }
            }

            // Extract donation categories
            const categoryMatches = query.match(/ARRAY\[([^\]]+)\]/i);
            if (categoryMatches) {
                const categories = categoryMatches[1]
                    .match(/'([^']+)'/g)
                    ?.map(cat => cat.replace(/'/g, ''));
                if (categories) {
                    data.donation_categories = categories;
                }
            }

            // Extract JSON fields
            const jsonFields = ['money', 'clothes', 'food', 'other'];
            for (const field of jsonFields) {
                const pattern = field + `[\\s]*=[\\s]*'(\\{[^}]+\\})'`;
                const jsonMatch = query.match(new RegExp(pattern, 'i'));
                if (jsonMatch) {
                    try {
                        data[field] = JSON.parse(jsonMatch[1].replace(/'/g, '"'));
                    } catch (e) {
                        console.warn(`Failed to parse ${field} JSON:`, e);
                    }
                }
            }

            // Extract preferred pickup date
            const dateMatch = query.match(/preferred_pickup_date[\s]*=[\s]*['"]([^'"]+)['"]/i);
            if (dateMatch) {
                data.preferred_pickup_date = dateMatch[1];
            }

            // Extract preferred pickup time
            const timeMatch = query.match(/preferred_pickup_time[\s]*=[\s]*['"]([^'"]+)['"]/i);
            if (timeMatch) {
                data.preferred_pickup_time = timeMatch[1];
            }

            return data;
        }

        // Test Function for Donation Insert
        async function testDonationInsert() {
            const testQuery = `INSERT INTO registrations (
    type,
    status,
    donor_type,
    anonymous,
    name,
    organization,
    phone,
    email,
    address,
    city,
    state,
    pincode,
    donation_categories,
    money,
    food,
    preferred_pickup_date,
    preferred_pickup_time,
    notes,
    terms_accepted
) VALUES (
    'donor',
    'Pending Review',
    'Individual',
    false,
    'Test Donor',
    null,
    '9876543210',
    'test@example.com',
    '123 Test Street, Test Area',
    'Mumbai',
    'Maharashtra',
    '400001',
    ARRAY['money', 'food'],
    '{"amount": 500, "currency": "INR", "paymentMethod": "UPI"}',
    '{"type": "Vegetarian", "quantity": "5 meals", "pickupAvailable": "Yes"}',
    CURRENT_DATE + INTERVAL '3 days',
    '10:00 AM - 1:00 PM',
    'Test donation for system verification',
    true
);`;

            document.getElementById('queryInput').value = testQuery;
            showSuccess('Test donation query loaded. Click Execute Query to test the insertion.');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'Enter':
                        e.preventDefault();
                        executeQuery();
                        break;
                    case '/':
                        e.preventDefault();
                        document.getElementById('queryInput').focus();
                        break;
                }
            }
        });
    </script>
</body>
</html>