<!-- CRITICAL: ADMIN PERMISSION REQUIRED BEFORE EDITING THIS FILE

     This file contains the admin dashboard for Kind Heart's Sangam Foundation.
     It includes sensitive admin functionality and Supabase integration.

     ANY CHANGES TO THIS FILE MUST BE APPROVED BY AN ADMINISTRATOR BEFORE IMPLEMENTATION.

     Contact admin before modifying:
     - Admin authentication logic
     - Supabase queries and data access
     - Dashboard UI and functionality
     - Data display and filtering

     Unauthorized edits may compromise admin security and data integrity.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - KIND HEART'S</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal__content {
            background: var(--white);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal__header {
            padding: 1.5rem;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal__header h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .modal__close {
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal__close:hover {
            color: #333;
        }

        .modal__body {
            padding: 1.5rem;
        }

        .form__group {
            margin-bottom: 1rem;
        }

        .form__group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form__success-message {
            color: #28a745;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        /* Security hardening */
        .admin-table {
            font-family: 'Roboto', sans-serif;
        }

        /* Disable text selection on sensitive data */
        .admin-table td {
            user-select: none;
        }

        /* Security headers */
        .security-headers {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        /* Dashboard specific styles */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-partner {
            background-color: #e0f2fe;
            color: #0369a1;
        }

        .badge-donor {
            background-color: #f0fdf4;
            color: #166534;
        }

        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-approved {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-rejected {
            background-color: #fef2f2;
            color: #dc2626;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .row-donor {
            border-left: 4px solid #16a34a;
        }

        .row-partner {
            border-left: 4px solid #2563eb;
        }

        .admin-table td {
            vertical-align: top;
        }

        .admin-table td small {
            color: #6b7280;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header__content">
                <span class="header__logo-text">Admin Dashboard</span>
                <div style="margin-left: auto; display: flex; gap: 1rem;">
                    <a href="sql-editor.html" class="button button--primary">
                        SQL Editor
                    </a>
                    <button id="logoutBtn" class="button button--secondary">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <h1 class="section__title">Registrations</h1>

            <div class="admin-controls">
                <input type="text" id="searchInput" class="form__input" placeholder="Search by Name/Organization...">
                <input type="text" id="cityFilter" class="form__input" placeholder="Filter by City...">
                <select id="typeFilter" class="form__input">
                    <option value="">All Types</option>
                    <option value="partner">Partners</option>
                    <option value="donor">Donors</option>
                </select>
                <select id="statusFilter" class="form__input">
                    <option value="">All Statuses</option>
                    <option value="Pending Review">Pending Review</option>
                    <option value="Approved">Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>
                <button id="changePasswordBtn" class="button button--secondary">Change Password</button>
            </div>

            <!-- Password Change Modal -->
            <div id="passwordModal" class="modal" style="display: none;">
                <div class="modal__content">
                    <div class="modal__header">
                        <h2>Change Admin Password</h2>
                        <span class="modal__close">&times;</span>
                    </div>
                    <div class="modal__body">
                        <form id="passwordChangeForm">
                            <div class="form__group">
                                <label for="currentPassword">Current Password:</label>
                                <input type="password" id="currentPassword" name="currentPassword" class="form__input" required>
                            </div>
                            <div class="form__group">
                                <label for="newPassword">New Password:</label>
                                <input type="password" id="newPassword" name="newPassword" class="form__input" required minlength="8">
                            </div>
                            <div class="form__group">
                                <label for="confirmPassword">Confirm New Password:</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" class="form__input" required minlength="8">
                            </div>
                            <div class="form__error-message" id="passwordError" style="display: none;"></div>
                            <div class="form__success-message" id="passwordSuccess" style="display: none;"></div>
                            <button type="submit" class="button button--primary">Update Password</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="loading-message">Loading data...</div>
            <div id="error-message" style="display:none; color: var(--error-color);"></div>

            <div style="overflow-x: auto;">
                <table class="admin-table">
                    <thead>
                        <tr id="table-headers"></tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        // Import Supabase client from separate file
        import supabase from './supabase-client.js';

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Dashboard loaded - checking authentication');

            // Check for valid admin session
            const isAuthenticated = sessionStorage.getItem('adminAuthenticated');
            const authTime = sessionStorage.getItem('adminAuthTime');
            const sessionExpiry = sessionStorage.getItem('adminSessionExpiry');

            if (!isAuthenticated || !authTime || !sessionExpiry) {
                document.getElementById('error-message').textContent = 'Error: No valid admin session found. Please login first.';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('loading-message').style.display = 'none';

                // Redirect to login page after 3 seconds
                setTimeout(() => {
                    window.location.href = 'admin-login.html';
                }, 3000);
                return;
            }

            // Check if session has expired
            if (Date.now() > parseInt(sessionExpiry)) {
                document.getElementById('error-message').textContent = 'Error: Admin session has expired. Please login again.';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('loading-message').style.display = 'none';

                // Clear expired session
                sessionStorage.removeItem('adminAuthenticated');
                sessionStorage.removeItem('adminAuthTime');
                sessionStorage.removeItem('adminSessionExpiry');

                // Redirect to login page after 3 seconds
                setTimeout(() => {
                    window.location.href = 'admin-login.html';
                }, 3000);
                return;
            }

            // Session is valid, load dashboard data
            loadDashboardData();
        });

        async function loadDashboardData() {
            console.log('Loading dashboard data from Supabase...');

            try {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const cityFilter = document.getElementById('cityFilter').value.toLowerCase();
                const typeFilter = document.getElementById('typeFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;

                // Query registrations table only
                let query = supabase.from('registrations').select('*');

                // Apply filters
                if (cityFilter) {
                    query = query.ilike('city', `%${cityFilter}%`);
                }

                if (statusFilter) {
                    query = query.eq('status', statusFilter);
                }

                if (searchTerm) {
                    query = query.or(`org_name.ilike.%${searchTerm}%,contact_person.ilike.%${searchTerm}%,name.ilike.%${searchTerm}%,organization.ilike.%${searchTerm}%`);
                }

                // Apply type-specific filters
                if (typeFilter === 'partner') {
                    query = query.eq('type', 'partner');
                } else if (typeFilter === 'donor') {
                    query = query.eq('type', 'donor');
                }

                query = query.order('created_at', { ascending: false });

                // Execute query
                const result = await query;

                if (result.error) throw new Error(result.error.message);

                const combinedData = result.data || [];

                console.log('Data received:', combinedData);
                displayData(combinedData || []);
                document.getElementById('loading-message').style.display = 'none';

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading-message').style.display = 'none';
                document.getElementById('error-message').textContent = `Error: ${error.message}`;
                document.getElementById('error-message').style.display = 'block';
            }
        }

        function displayData(data) {
            const tableHeaders = document.getElementById('table-headers');
            const tableBody = document.getElementById('table-body');

            tableHeaders.innerHTML = '';
            tableBody.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="100%">No data found.</td></tr>';
                return;
            }

            // Define headers based on data type
            const headers = [
                'Type', 'Name/Organization', 'Contact', 'Location', 'Details', 'Status', 'Date'
            ];

            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                tableHeaders.appendChild(th);
            });

            // Create rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = `row-${row.type || 'unknown'}`;

                // Type
                const typeTd = document.createElement('td');
                typeTd.innerHTML = `<span class="badge badge-${row.type || 'unknown'}">${row.type === 'donor' ? 'Donor' : 'Partner'}</span>`;
                tr.appendChild(typeTd);

                // Name/Organization
                const nameTd = document.createElement('td');
                if (row.type === 'donor') {
                    nameTd.innerHTML = `
                        <strong>${row.anonymous ? 'Anonymous' : (row.name || 'N/A')}</strong><br>
                        ${row.organization ? `<small>Organization: ${row.organization}</small>` : ''}
                    `;
                } else {
                    nameTd.innerHTML = `
                        <strong>${row.org_name || 'N/A'}</strong><br>
                        <small>Contact: ${row.contact_person || 'N/A'}</small>
                    `;
                }
                tr.appendChild(nameTd);

                // Contact
                const contactTd = document.createElement('td');
                contactTd.innerHTML = `
                    ${row.phone || 'N/A'}<br>
                    <small>${row.email || 'N/A'}</small>
                `;
                tr.appendChild(contactTd);

                // Location
                const locationTd = document.createElement('td');
                locationTd.innerHTML = `
                    ${row.city || 'N/A'}<br>
                    <small>${row.state || 'N/A'}</small>
                `;
                tr.appendChild(locationTd);

                // Details
                const detailsTd = document.createElement('td');
                if (row.type === 'donor') {
                    const categories = Array.isArray(row.donation_categories) ? row.donation_categories.join(', ') : 'N/A';
                    detailsTd.innerHTML = `
                        <strong>Categories:</strong> ${categories}<br>
                        ${row.money ? `<small>Money: â‚¹${row.money.amount || 'N/A'}</small><br>` : ''}
                        ${row.clothes ? `<small>Clothes: ${row.clothes.count || 'N/A'} items</small><br>` : ''}
                        ${row.food ? `<small>Food: ${row.food.quantity || 'N/A'}</small><br>` : ''}
                    `;
                } else {
                    detailsTd.innerHTML = `
                        <strong>Type:</strong> ${row.org_type || 'N/A'}<br>
                        <strong>Food Type:</strong> ${row.food_type || 'N/A'}<br>
                        <strong>Capacity:</strong> ${row.food_capacity || 'N/A'}
                    `;
                }
                tr.appendChild(detailsTd);

                // Status
                const statusTd = document.createElement('td');
                const statusClass = row.status === 'Approved' ? 'status-approved' :
                                  row.status === 'Rejected' ? 'status-rejected' : 'status-pending';
                statusTd.innerHTML = `<span class="status ${statusClass}">${row.status || 'Pending'}</span>`;
                tr.appendChild(statusTd);

                // Date
                const dateTd = document.createElement('td');
                dateTd.innerHTML = `<small>${new Date(row.created_at).toLocaleDateString()}</small>`;
                tr.appendChild(dateTd);

                tableBody.appendChild(tr);
            });
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            // Clear all session data
            sessionStorage.removeItem('adminAuthenticated');
            sessionStorage.removeItem('adminAuthTime');
            sessionStorage.removeItem('adminSessionExpiry');

            // Clear any sensitive data from memory
            if (window.performance && window.performance.clearResourceTimings) {
                window.performance.clearResourceTimings();
            }

            // Redirect to login page
            window.location.href = 'admin-login.html';
        });

        // Security: Clear console logs and prevent inspect element data exposure
        document.addEventListener('keydown', (e) => {
            // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            if (e.keyCode === 123 || // F12
                (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || // Ctrl+Shift+I/J
                (e.ctrlKey && e.keyCode === 85)) { // Ctrl+U
                e.preventDefault();
                return false;
            }
        });

        // Disable right-click context menu
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            return false;
        });

        // Clear sensitive data from memory periodically
        setInterval(() => {
            // Force garbage collection if available
            if (window.gc) {
                window.gc();
            }
        }, 30000); // Every 30 seconds

        // Search and filter functionality
        document.getElementById('searchInput').addEventListener('input', filterData);
        document.getElementById('cityFilter').addEventListener('input', filterData);
        document.getElementById('typeFilter').addEventListener('change', filterData);
        document.getElementById('statusFilter').addEventListener('change', filterData);

        function filterData() {
            loadDashboardData();
        }

        // Password Change Functionality
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const passwordModal = document.getElementById('passwordModal');
        const passwordChangeForm = document.getElementById('passwordChangeForm');
        const modalClose = document.querySelector('.modal__close');
        const passwordError = document.getElementById('passwordError');
        const passwordSuccess = document.getElementById('passwordSuccess');

        // Open password change modal
        changePasswordBtn.addEventListener('click', () => {
            passwordModal.style.display = 'flex';
            document.getElementById('currentPassword').focus();
        });

        // Close modal
        modalClose.addEventListener('click', closePasswordModal);
        passwordModal.addEventListener('click', (e) => {
            if (e.target === passwordModal) {
                closePasswordModal();
            }
        });

        function closePasswordModal() {
            passwordModal.style.display = 'none';
            passwordChangeForm.reset();
            passwordError.style.display = 'none';
            passwordSuccess.style.display = 'none';
        }

        // Handle password change form submission
        passwordChangeForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Clear previous messages
            passwordError.style.display = 'none';
            passwordSuccess.style.display = 'none';

            // Validate passwords
            if (newPassword !== confirmPassword) {
                showPasswordError('New passwords do not match.');
                return;
            }

            if (newPassword.length < 8) {
                showPasswordError('New password must be at least 8 characters long.');
                return;
            }

            if (newPassword === currentPassword) {
                showPasswordError('New password must be different from current password.');
                return;
            }

            try {
                // Get current stored password data
                const { data, error } = await supabase
                    .from('admin_credentials')
                    .select('password_hash, salt')
                    .eq('id', 1)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                    throw new Error('Error fetching current credentials');
                }

                let isCurrentValid = false;

                if (data) {
                    // Validate against stored hash
                    isCurrentValid = await validatePassword(currentPassword, data.password_hash, data.salt);
                } else {
                    // Fallback to hardcoded password for backward compatibility
                    isCurrentValid = (currentPassword === '28112811');
                }

                if (!isCurrentValid) {
                    showPasswordError('Current password is incorrect.');
                    return;
                }

                // Generate new salt and hash
                const newSalt = generateSalt();
                const newHash = await hashPassword(newPassword, newSalt);

                // Update password in database
                const { error: updateError } = await supabase
                    .from('admin_credentials')
                    .upsert({
                        id: 1,
                        password_hash: newHash,
                        salt: newSalt,
                        updated_at: new Date().toISOString()
                    });

                if (updateError) {
                    throw new Error('Error updating password');
                }

                showPasswordSuccess('Password updated successfully!');
                setTimeout(() => {
                    closePasswordModal();
                }, 2000);

            } catch (error) {
                console.error('Password change error:', error);
                showPasswordError('Error updating password. Please try again.');
            }
        });

        function showPasswordError(message) {
            passwordError.textContent = message;
            passwordError.style.display = 'block';
            passwordSuccess.style.display = 'none';
        }

        function showPasswordSuccess(message) {
            passwordSuccess.textContent = message;
            passwordSuccess.style.display = 'block';
            passwordError.style.display = 'none';
        }

        async function generateSalt() {
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        }

        async function hashPassword(password, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + salt);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function validatePassword(password, storedHash, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + salt);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex === storedHash;
        }

        // Additional security measures
        let consoleLogs = [];
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        // Override console methods to filter sensitive data
        console.log = function(...args) {
            const logMessage = args.join(' ');
            // Filter out sensitive information
            if (!logMessage.includes('password') &&
                !logMessage.includes('token') &&
                !logMessage.includes('key') &&
                !logMessage.includes('secret')) {
                consoleLogs.push({ type: 'log', message: logMessage, timestamp: Date.now() });
                originalConsoleLog.apply(console, args);
            }
        };

        console.error = function(...args) {
            const logMessage = args.join(' ');
            consoleLogs.push({ type: 'error', message: logMessage, timestamp: Date.now() });
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            const logMessage = args.join(' ');
            consoleLogs.push({ type: 'warn', message: logMessage, timestamp: Date.now() });
            originalConsoleWarn.apply(console, args);
        };

        // Clear console logs periodically
        setInterval(() => {
            consoleLogs = consoleLogs.filter(log => Date.now() - log.timestamp < 60000); // Keep only last minute
        }, 60000);

        // Security: Prevent window opening
        window.open = function() {
            console.warn('Window opening blocked for security');
            return null;
        };

        // Security: Disable source viewing
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.keyCode === 83) { // Ctrl+S
                e.preventDefault();
                console.warn('Save blocked for security');
                return false;
            }
        });

        // Clear clipboard on page unload
        window.addEventListener('beforeunload', () => {
            if (navigator.clipboard) {
                navigator.clipboard.writeText('');
            }
        });
    </script>
</body>
</html>